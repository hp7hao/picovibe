## 6.6 地图

PICO-8 地图是一个 128x32 的 8 位值网格，或在使用共享内存时为 128x64。在使用地图编辑器时，每个值被视为精灵表中的一个索引（0..255）。但是，它也可以用作一般的数据块。

##### MGET(X, Y)

##### MSET(X, Y, VAL)

获取或设置 X,Y 处的地图值 (VAL)

当 X 和 Y 超出范围时，MGET 返回 0，或者可以通过以下方式指定自定义返回值：

```
POKE(0x5f36, 0x10)  
POKE(0x5f5a, NEWVAL)  
```

##### MAP(TILE_X, TILE_Y, [SX, SY], [TILE_W, TILE_H], [LAYERS])

从 TILE_X, TILE_Y 开始绘制地图的一部分，在屏幕位置 SX, SY (像素) 处。

要从地图的 0,0 开始绘制 4x2 块的瓦片到屏幕的 20,20 处：

```
MAP(0, 0, 20, 20, 4, 2)  
```

TILE_W 和 TILE_H 默认为整个地图（包括适用的共享空间）。

MAP() 通常与 CAMERA() 结合使用。要使玩家对象（以像素为单位位于 PL.X, PL.Y）居中：

```
CAMERA(PL.X - 64, PL.Y - 64)  
MAP()  
```

LAYERS 是一个位字段。当提供时，只有具有匹配精灵标志的精灵会被绘制。例如，当 LAYERS 为 0x5 时，只有具有标志 0 和 2 的精灵会被绘制。

精灵 0 被视为“空”且不被绘制。要禁用此行为，使用：POKE(0x5F36, 0x8)

  
##### TLINE(X0, Y0, X1, Y1, MX, MY, [MDX, MDY], [LAYERS])

从 (X0,Y0) 到 (X1,Y1) 绘制一条纹理线，从地图采样颜色值。当指定 LAYERS 时，只有具有匹配标志的精灵会被绘制（类似于 MAP()）

MX, MY 是地图坐标，以瓦片为单位进行采样。颜色值从每个地图瓦片上的 8x8 精灵中采样。例如：

2.0, 1.0  表示地图上位置 2,1 处的精灵的左上角  
2.5, 1.5  表示相同精灵的像素 (4,4)  

MDX, MDY 是在绘制每个像素后添加到 mx, my 的增量。（默认为 0.125, 0）

地图坐标 (MX, MY) 通过从地址 0x5F38 和 0x5F39 的值减去 0x0.0001 进行掩码。简单来说，这意味着可以通过 pocking 想要循环的宽度和高度来循环地图的一部分，只要它们是 2 的幂（2,4,8,16..）

例如，要每 8 个瓦片水平循环，每 4 个瓦片垂直循环：

```
POKE(0x5F38, 8)  
POKE(0x5F39, 4)  
TLINE(...)  
```

默认值 (0,0) 提供一个掩码 0xff.ffff，这意味着样本每 256 个瓦片循环一次。

也可以在地址 0x5f3a, 0x5f3b 指定一个采样偏移（以瓦片为单位）：

```
POKE(0x5F3A, OFFSET_X)  
POKE(0x5F3B, OFFSET_Y)  
```

精灵 0 被视为“空”且不被绘制。要禁用此行为，使用：POKE(0x5F36, 0x8)

#### ■ 设置 TLINE 精度

默认情况下，tline 坐标 (mx,my,mdx,mdy) 以瓦片为单位表示。这意味着 1 个像素是 0.125，只有 13 位用于小数部分。如果需要更高的精度，可以通过调用 TLINE 并传递一个参数来调整坐标空间，以允许更多位用于小数部分。这对于纹理墙等场景很有用，因为 mdx,mdy 的累积误差在近距离查看时可能会变得明显。

每个像素的小数部分使用的位数存储在一个特殊寄存器中，可以通过调用 TLINE 并传递一个参数来调整：

TLINE(16) -- MX,MY,MDX,MDY 以像素为单位表示