# 6 应用程序接口参考

PICO-8 基于 Lua 编程语言，但不包括 Lua 标准库。相反，提供了一个小型 API，符合 PICO-8 的极简设计和有限的屏幕空间。有关使用大多数 API 函数的示例程序，请参见 /DEMOS/API.P8

函数在此处写为：

FUNCTION_NAME(PARAMETER, [OPTIONAL_PARAMETER])

ⓘ 请注意，PICO-8 不区分大小写 -- 如果直接编辑 .p8 或 .lua 文件，函数名应全部为小写。

## 6.1 系统

通过命令行调用的系统函数可以省略通常的括号和字符串引号。例如，而不是 LOAD("BLAH.P8")，可以写为：

>LOAD BLAH.P8  

  
##### LOAD(FILENAME, [BREADCRUMB], [PARAM_STR])

加载或保存卡带

当从正在运行的卡带加载时，加载的卡带会立即运行，并带有参数字符串 PARAM_STR（可通过 STAT(6) 访问），并且会插入一个菜单项，名称为 BREADCRUMB，返回到之前的卡带。

以 '#' 开头的文件名被视为 BBS 卡带 ID，会立即下载并运行：

```
> LOAD("#MYGAME_LEVEL2", "BACK TO MAP", "LIVES="..LIVES)  
```

如果 ID 是卡带的父帖子，或未指定修订号，则会获取最新版本。BBS 卡带可以从其他 BBS 卡带或本地卡带加载，但不能从导出的卡带加载。

  
##### SAVE(FILENAME)

加载或保存卡带

  
##### FOLDER

在主机操作系统中打开卡带文件夹。

  
##### LS([DIRECTORY])

列出给定目录（文件夹）中的 .p8 和 .p8.png 文件，相对于当前目录。目录项以斜杠结尾（例如 "foo/"）。

当从正在运行的卡带调用时，LS 只能本地使用，并返回结果表。当从 BBS 卡带调用时，LS 返回 nil。

目录只能解析到 PICO-8 的虚拟驱动器内部；从根目录调用 LS("..") 将解析到根目录。

  
##### RUN([PARAM_STR])

从程序的开头运行。

RUN() 可以在正在运行的程序中调用以重置。

当提供 PARAM_STR 时，可以在运行时通过 STAT(6) 访问它。

  
##### STOP([MESSAGE])

停止卡带并可选地打印消息。

  
##### RESUME

恢复程序。使用 R 作为快捷方式。

使用单个 "." 从命令行进入单帧模式。这会进入帧级模式，可以通过 stat(110) 读取。当帧级模式处于活动状态时，输入空命令（通过按回车键）会前进一帧。

  
##### ASSERT(CONDITION, [MESSAGE])

如果 CONDITION 为假，则停止程序并打印 MESSAGE（如果提供）。这对于调试卡带很有用，通过 ASSERT() 确保预期为真的事情确实是真实的。

```
ASSERT(ADDR >= 0 AND ADDR <= 0x7FFF, "OUT OF RANGE")  
POKE(ADDR, 42) -- THE MEMORY ADDRESS IS OK, FOR SURE!  
```
  
##### REBOOT

重启机器。适用于启动新项目

  
##### RESET()

将 RAM 中 0x5f00..0x5f7f 的值重置为其默认值。这包括调色板、相机位置、裁剪和填充模式。如果在命令提示符处迷路，因为绘图状态使得查看文本变得不可能，可以尝试输入 RESET! 也可以在正在运行的程序中调用。

  
##### INFO()

打印有关卡带的一些信息：代码大小、标记、压缩大小

还会显示：

UNSAVED CHANGES   当内存中的卡带与磁盘上的卡带不同时  
EXTERNAL CHANGES  当磁盘上的卡带自加载以来已更改  
  (例如，通过使用单独的文本编辑器编辑程序)  

  
##### FLIP()

翻转后缓冲区到屏幕并等待下一帧。当定义了 [**_DRAW**]() 或 [**_UPDATE**]() 回调时，不需要此调用，因为会自动进行翻转。但在使用自定义主循环时，通常需要调用 FLIP：

```
::_::  
CLS()  
FOR I=1,100 DO  
  A=I/50 - T()  
  X=64+COS(A)\*I  
  Y=64+SIN(A)\*I  
  CIRCFILL(X,Y,1,8+(I/4)%8)  
END  
FLIP()GOTO _  
```

如果程序在帧结束前没有调用 FLIP，并且没有 [**_DRAW**]() 回调正在进行中，则会将后缓冲区的当前内容复制到屏幕。

  
##### PRINTH(STR, [FILENAME], [OVERWRITE], [SAVE_TO_DESKTOP])

将字符串打印到主机操作系统的控制台进行调试。

如果设置了 filename，则将字符串追加到主机操作系统中的文件（默认为当前目录 -- 使用 FOLDER 查看）。

设置 OVERWRITE 为 true 会导致该文件被覆盖而不是追加。

设置 SAVE_TO_DESKTOP 为 true 会将内容保存到桌面而不是当前路径。

使用 "@clip" 作为文件名可以写入主机的剪贴板。

ⓘ 使用 stat(4) 读取剪贴板内容，但剪贴板内容仅在运行时按下 CTRL-V 后可用（出于安全考虑）。

  
##### TIME()

##### T()

返回自卡带运行以来的秒数。

这不是实际世界的时间，而是通过计算

  
##### _UPDATE 或 @\_UPDATE60 被调用的次数来计算的。

  
##### STAT(X)

获取系统状态，其中 X 为：

```
0  内存使用情况 (0..2048)  
1  自上次翻转以来使用的 CPU (1.0 == 100% CPU)  
4  剪贴板内容（用户按下 CTRL-V 后）  
6  参数字符串  
7  当前帧率

46..49  当前在通道 0..3 上播放的 SFX 的索引  
50..53  通道 0..3 上的音符编号 (0..31)  
54      当前播放的模式索引  
55      播放的模式总数  
56      当前模式播放的节拍数  
57      (Boolean) 当前是否正在播放音乐

80..85  UTC 时间：年、月、日、小时、分钟、秒  
90..95  本地时间

100     当前面包屑标签，或 nil  
110     当处于帧级模式时返回 true
```

ⓘ 音频值 16..26 是音频状态查询 46..56 的旧版本。它们仅报告音频混音器的当前状态，该状态每秒变化约 20 次（取决于主机声音驱动程序和其他因素）。46..56 而是存储了每个节拍的混音器状态，以提供当前可听状态的更高分辨率估计。

  
##### EXTCMD(CMD_STR, [P1, P2])

特殊系统命令，其中 CMD_STR 为字符串：

```
"pause"         请求打开暂停菜单  
"reset"         请求卡带重置  
"go_back"       如果存在则返回到之前的卡带  
"label"         设置卡带标签  
"screen"        保存屏幕截图  
"rec"           设置视频开始点  
"rec_frames"    设置视频开始点为帧模式  
"video"         保存 .gif 到桌面  
"audio_rec"     开始录制音频  
"audio_end"     将录制的音频保存到桌面（Web 不支持）  
"shutdown"      退出卡带（从导出的二进制文件）  
"folder"        在主机操作系统中打开当前工作文件夹  
"set_filename"  设置屏幕截图 / gif / 音频录制的文件名  
"set_title"     设置主机窗口标题  
```

某些命令具有可选的数字参数：

"video" 和 "screen": P1: 一个整数缩放因子，覆盖系统设置。P2: 当 > 0 时，保存到当前文件夹而不是桌面

"audio_end" P1: 当 > 0 时，保存到当前文件夹而不是桌面

#### ▨ 录制 GIF

EXTCMD("REC"), EXTCMD("VIDEO") 与使用 ctrl-8, ctrl-9 相同，并使用当前的 GIF_SCALE 设置保存桌面中的 gif（使用 CONFIG GIF_SCALE 更改）。

可以使用两个附加参数来覆盖这些默认值：
```
EXTCMD("VIDEO", 4)    -- SCALE \*4 (512 X 512)  
EXTCMD("VIDEO", 0, 1) -- 默认缩放，保存到用户数据文件夹  
```

用户数据文件夹可以通过 EXTCMD("FOLDER") 打开，默认为与卡带相同的路径，或 {pico-8 appdata}/appdata/appname 对于导出的二进制文件。

由于 gif 格式的性质，所有 gif 都以 33.3fps 录制，并且 PICO-8 生成的帧会根据用户看到的内容进行跳帧或重复。要记录每次调用 [**FLIP**]() 时恰好一帧，无论运行时帧率或生成帧所需的时间，使用：

```
EXTCMD("REC_FRAMES")  
```

gif（以及截图、音频）的默认文件名是 foo_%d，其中 foo 是卡带的名称，%d 是从 0 开始的数字，自动递增，直到不存在同名文件。使用 EXTCMD("SET_FILENAME","FOO") 可以覆盖默认值。如果自定义文件名包含 "%d"，则使用自动递增数字行为，否则即使存在同名文件也会写入文件。